# リトライポリシー（エージェント活用型）

**重要**: 問題が発生した場合、独力でリトライすることは禁止。必ず専門エージェントに相談してから再試行すること。

---

## 基本原則

```
❌ NG: 独力で何度もリトライ
✅ OK: エージェントに相談 → 助言を得てリトライ
```

**最大5回まで試行可能だが、各失敗後は必ずエージェントに相談**

---

## エージェント活用型リトライフロー

```
問題発生
  ↓
試行1 → 失敗
  ↓
専門エージェントに相談 ← ★ 必須
  ↓
助言を得る
  ↓
試行2 → 失敗
  ↓
再度エージェントに相談（状況更新）← ★ 必須
  ↓
...
  ↓
試行5 → 失敗
  ↓
ユーザーに報告（エージェントの助言含む）
```

---

## タスク種別ごとの相談先エージェント

| タスク種別 | 相談先エージェント | 相談内容 |
|-----------|------------------|---------|
| **UI/UX問題** | `designer` | デザイン原則、ユーザビリティ、アクセシビリティ |
| **コード実装エラー** | `tech-lead` | コード品質、アーキテクチャ、実装方針 |
| **テスト失敗** | `qa-engineer` | テストケース、エッジケース、テスト戦略 |
| **要件不明確** | `product-manager` | 要件定義、仕様、受け入れ基準 |
| **ビルドエラー** | `tech-lead` | 依存関係、設定、ビルドプロセス |
| **型エラー** | `tech-lead` | TypeScript型定義、型安全性 |

---

## エージェント相談テンプレート

相談時は以下の情報を提供すること：

```markdown
## エージェント相談

### 発生した問題
[問題の概要]

### エラー内容
```
[エラーメッセージ全文]
```

### 試行履歴
1. 試行1: [実施内容] → 結果: [失敗理由]
2. 試行2: [実施内容] → 結果: [失敗理由]
...

### 現在の状況
- ブランチ: [ブランチ名]
- 変更ファイル: [ファイル一覧]
- 実行したコマンド: [コマンド]

### 質問
1. この問題の根本原因は何か？
2. 推奨される解決方法は？
3. 代替アプローチはあるか？
```

---

## リトライ実施フロー

**各試行の前に必ず実施:**

### Step 1: エージェントに相談
```
"[エージェント名] エージェントに以下の問題について相談してください：
[エラー内容と試行履歴]"
```

### Step 2: エージェントからの助言を確認
- 根本原因の分析
- 推奨される解決方法
- 注意点

### Step 3: 助言に基づいて再試行
エージェントの推奨方法を実施

### Step 4: 結果を記録
成功/失敗と理由を記録し、必要なら再度相談

---

## 報告基準

**5回試行しても問題が解消されない場合、ユーザーに詳細報告**

報告メッセージ例：

```
⚠️ 同じエラーが5回続いています。
専門エージェントに相談しましたが、解決に至りませんでした。

## 問題概要
[問題の説明]

## エラー内容
[エラーメッセージ]

## 試行履歴（エージェント相談含む）
1. 試行1: [内容] → 失敗
   → tech-lead 助言: [助言内容]
2. 試行2: [内容] → 失敗
   → tech-lead 助言: [助言内容]
...

## エージェントの最終見解
[エージェントが提示した根本原因と推奨対応]

## 推奨対応
別のアプローチが必要かもしれません：
- [代替案1]
- [代替案2]
```

---

## リトライ対象

**以下の場合はエージェントに相談してリトライ:**

- npm installの失敗
- テスト実行の一時的な失敗
- ネットワークエラー
- ファイルI/Oエラー
- ビルドエラー（環境依存の可能性がある場合）
- 型エラー（TypeScript）
- 依存関係の問題

---

## 即座にユーザー報告（リトライしない）

**以下の場合はリトライせず、即座にユーザーに報告:**

- 文法エラー（明らかな実装ミス）
- 論理エラー（要件理解の誤り）
- テスト失敗（コードの問題が明確）
- ユーザーの確認が必要な事項（仕様判断等）
- セキュリティ上の懸念

---

## エージェント相談の具体例

### 例1: テスト失敗時

```
"qa-engineer エージェントに以下のテスト失敗について相談してください：

### 問題
photo-service.test.ts のテストが失敗しています。

### エラー
```
Expected: { location: {...} }
Received: undefined
```

### 試行履歴
1. 試行1: モックデータを追加 → 依然として undefined
2. 試行2: async/await を確認 → 変わらず失敗

### 質問
- モックの設定に問題があるか？
- 非同期処理の待機方法に問題があるか？
- テストケース設計に問題があるか？
"
```

### 例2: ビルドエラー時

```
"tech-lead エージェントに以下のビルドエラーについて相談してください：

### 問題
npm run build が失敗します。

### エラー
```
Module not found: Can't resolve '@/lib/new-service'
```

### 試行履歴
1. 試行1: パスエイリアスを確認 → tsconfig.json は正しい
2. 試行2: npm install 実行 → エラー変わらず

### 質問
- モジュール解決の設定に問題があるか？
- ビルドプロセスに問題があるか？
"
```

---

**重要**: このポリシーにより、問題解決の質が向上し、同じエラーを繰り返すことを防ぎます。エージェントの専門知識を活用して、効率的に問題を解決してください。
