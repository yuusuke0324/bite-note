# Bite Note - AI駆動開発ガイドライン

プロジェクト: 個人釣果記録PWA (React + TypeScript + IndexedDB)
開発方針: モック優先・動作重視のMVP開発

## 🚨 重要規則 (MUST)

### Git作業フロー
- **mainブランチでの直接作業は絶対禁止**: いかなる変更もmainブランチに直接コミットしない
- **作業開始時**: 必ず専用ブランチを作成（feat-<機能名>、fix-<修正内容>等）
- **作業終了時**: コミット → リモートpush → PR作成の3ステップを必ず実施
- **コミット・PR作成**: ai-rules/COMMIT_AND_PR_GUIDELINES.md を必ず参照
- **Issue作成**: ai-rules/ISSUE_GUIDELINES.md を必ず参照

### コード品質
- **設計書管理必須**: コード改修前に設計書の更新要否を判断
- **完了確認必須**: 改修完了後、ユーザーに報告し承認を得る
- **テスト実行必須**: コード変更後は `npm run test:fast` で動作確認
- **型安全性維持**: TypeScript型定義を省略しない

### 専門エージェント活用
- **テックリードレビュー**: コード改修後は `tech-lead` エージェントに依頼
- **QAエンジニアレビュー**: テストコード作成・修正時は `qa-engineer` エージェントに依頼
- **PM要件定義**: 新機能企画時は `product-manager` エージェントに依頼
- **デザイナーレビュー**: UI/UX実装時は `designer` エージェントに依頼（必須）

### アーキテクチャ
- **IndexedDB操作**: Dexieサービス層経由で実行（直接操作禁止）
- **コンポーネント配置**: features/以下に機能ごとに整理

---

## 🎯 プロジェクト固有パターン

### サービス層アーキテクチャ
```
src/lib/*-service.ts パターンを必ず使用:
- fishing-record-service.ts → 釣果CRUD
- photo-service.ts → 写真管理
- weather-service.ts → 天気API
- export-import-service.ts → データ入出力
```

### 状態管理
```
Zustand + Immer で実装:
- stores/app-store.ts → グローバル状態
- stores/form-store.ts → フォーム状態
- 非同期処理は必ずtry-catchでラップ
```

### UI/UXパターン
```
統一コンポーネント使用:
- ui/Skeleton*.tsx → ローディング表示
- ui/ModernCard.tsx → カード表示
- ui/FloatingActionButton.tsx → FAB
```

---

## 🔧 開発コマンド

### よく使うコマンド
```bash
# q1: 開発サーバー起動
npm run dev

# q2: テスト実行（高速）
npm run test:fast

# q3: ビルド & 本番確認
npm run build && npm run preview

# q4: 型チェック
npm run typecheck

# q5: コンポーネントテスト
npm run test:components
```

### デバッグ・調査
```bash
# IndexedDBの中身を確認
# → Chrome DevTools > Application > Storage > IndexedDB

# パフォーマンス測定
npm run performance:test

# メモリプロファイル
npm run memory:profile
```

---

## 📂 ファイル配置ルール

```
新機能追加時:
├── src/components/features/[機能名]/
│   ├── [機能名].tsx           # メインコンポーネント
│   ├── [機能名].test.tsx      # テスト
│   └── components/            # サブコンポーネント
├── src/lib/[機能名]-service.ts  # サービス層
└── src/types/[機能名].ts        # 型定義
```

---

## 🔄 作業フロー（全てのタスクで必須）

### 📝 タスクTodo記載ルール

**すべての機能追加・修正タスクで以下を必ずtodoに含めること:**

```
1. [作業開始時] 専用ブランチ作成
2. [実装内容のタスク...]
3. [作業終了時] 変更をコミット
4. [作業終了時] リモートブランチにpush
5. [作業終了時] PR作成（MCPツール使用）
```

### 🎬 作業開始時（必須3ステップ）

```bash
# Step 1: 現在のブランチを確認
git branch --show-current
# ⚠️ mainブランチの場合は即座に停止

# Step 2: 専用ブランチを作成
git checkout -b feat/<機能名>    # 新機能
git checkout -b fix/<修正内容>   # バグ修正
git checkout -b refactor/<対象>  # リファクタリング

# Step 3: ガイドライン確認
# ai-rules/COMMIT_AND_PR_GUIDELINES.md を読む
```

### 🏁 作業終了時（必須3ステップ）

```bash
# Step 1: 変更をコミット
git add .
git commit -m "<type>(<scope>): <subject>"
# 詳細は ai-rules/COMMIT_AND_PR_GUIDELINES.md 参照

# Step 2: リモートブランチにpush
git push -u origin <ブランチ名>

# Step 3: PR作成（MCPツール使用）
# ai-rules/COMMIT_AND_PR_GUIDELINES.md のテンプレート使用
# gh pr create コマンドまたはMCPツールで作成
```

---

## 🔁 リトライポリシー（エージェント活用型）

### ⚠️ 重要: 独力でのリトライは禁止

**問題が発生した場合、必ず専門エージェントに相談してから再試行すること**

```
❌ NG: 独力で何度もリトライ
✅ OK: エージェントに相談 → 助言を得てリトライ
```

### エージェント活用型リトライフロー

**最大5回まで試行可能だが、各失敗後は必ずエージェントに相談**

```
問題発生
  ↓
試行1 → 失敗
  ↓
専門エージェントに相談 ← ★ 必須
  ↓
助言を得る
  ↓
試行2 → 失敗
  ↓
再度エージェントに相談（状況更新）← ★ 必須
  ↓
...
  ↓
試行5 → 失敗
  ↓
ユーザーに報告（エージェントの助言含む）
```

### タスク種別ごとの相談先エージェント

| タスク種別 | 相談先エージェント | 相談内容 |
|-----------|------------------|---------|
| **UI/UX問題** | `designer` | デザイン原則、ユーザビリティ、アクセシビリティ |
| **コード実装エラー** | `tech-lead` | コード品質、アーキテクチャ、実装方針 |
| **テスト失敗** | `qa-engineer` | テストケース、エッジケース、テスト戦略 |
| **要件不明確** | `product-manager` | 要件定義、仕様、受け入れ基準 |
| **ビルドエラー** | `tech-lead` | 依存関係、設定、ビルドプロセス |
| **型エラー** | `tech-lead` | TypeScript型定義、型安全性 |

### エージェントへの相談内容

相談時は以下の情報を提供すること：

```markdown
## エージェント相談テンプレート

### 発生した問題
[問題の概要]

### エラー内容
```
[エラーメッセージ全文]
```

### 試行履歴
1. 試行1: [実施内容] → 結果: [失敗理由]
2. 試行2: [実施内容] → 結果: [失敗理由]
...

### 現在の状況
- ブランチ: [ブランチ名]
- 変更ファイル: [ファイル一覧]
- 実行したコマンド: [コマンド]

### 質問
1. この問題の根本原因は何か？
2. 推奨される解決方法は？
3. 代替アプローチはあるか？
```

### リトライ実施フロー

**各試行の前に必ず実施:**

```bash
# Step 1: エージェントに相談
"[エージェント名] エージェントに以下の問題について相談してください：
[エラー内容と試行履歴]"

# Step 2: エージェントからの助言を確認
# - 根本原因の分析
# - 推奨される解決方法
# - 注意点

# Step 3: 助言に基づいて再試行
# エージェントの推奨方法を実施

# Step 4: 結果を記録
# 成功/失敗と理由を記録し、必要なら再度相談
```

### 報告基準

**5回試行しても問題が解消されない場合、ユーザーに詳細報告**

報告メッセージ例：
```
⚠️ 同じエラーが5回続いています。
専門エージェントに相談しましたが、解決に至りませんでした。

## 問題概要
[問題の説明]

## エラー内容
[エラーメッセージ]

## 試行履歴（エージェント相談含む）
1. 試行1: [内容] → 失敗
   → tech-lead 助言: [助言内容]
2. 試行2: [内容] → 失敗
   → tech-lead 助言: [助言内容]
...

## エージェントの最終見解
[エージェントが提示した根本原因と推奨対応]

## 推奨対応
別のアプローチが必要かもしれません：
- [代替案1]
- [代替案2]
```

### リトライ対象

**以下の場合はエージェントに相談してリトライ:**

- npm installの失敗
- テスト実行の一時的な失敗
- ネットワークエラー
- ファイルI/Oエラー
- ビルドエラー（環境依存の可能性がある場合）
- 型エラー（TypeScript）
- 依存関係の問題

### 即座にユーザー報告（リトライしない）

**以下の場合はリトライせず、即座にユーザーに報告:**

- 文法エラー（明らかな実装ミス）
- 論理エラー（要件理解の誤り）
- テスト失敗（コードの問題が明確）
- ユーザーの確認が必要な事項（仕様判断等）
- セキュリティ上の懸念

### エージェント相談の具体例

#### 例1: テスト失敗時

```
"qa-engineer エージェントに以下のテスト失敗について相談してください：

### 問題
photo-service.test.ts のテストが失敗しています。

### エラー
```
Expected: { location: {...} }
Received: undefined
```

### 試行履歴
1. 試行1: モックデータを追加 → 依然として undefined
2. 試行2: async/await を確認 → 変わらず失敗

### 質問
- モックの設定に問題があるか？
- 非同期処理の待機方法に問題があるか？
- テストケース設計に問題があるか？
"
```

#### 例2: ビルドエラー時

```
"tech-lead エージェントに以下のビルドエラーについて相談してください：

### 問題
npm run build が失敗します。

### エラー
```
Module not found: Can't resolve '@/lib/new-service'
```

### 試行履歴
1. 試行1: パスエイリアスを確認 → tsconfig.json は正しい
2. 試行2: npm install 実行 → エラー変わらず

### 質問
- モジュール解決の設定に問題があるか？
- ビルドプロセスに問題があるか？
"
```

---

## ⛔ 作業完了報告禁止条件

**以下のいずれかの状態では「完了」と報告してはいけない:**

### 絶対禁止条件

```
❌ テストが失敗している
   - npm run test:fast が失敗
   - npm run test:ci が失敗
   - 例外: 未実装機能用のテスト作成時（明示的にskip）

❌ コンパイルエラーがある
   - npm run typecheck が失敗
   - npm run build が失敗

❌ 以前の試行で発生したエラーが未解決のまま残っている
   - リトライ中に発生したエラーの根本原因が不明
   - 暫定的な回避策のみで対応

❌ 専門エージェントレビューが未完了
   - tech-lead レビュー未実施（コード改修時）
   - qa-engineer レビュー未実施（テストコード修正時）
   - product-manager レビュー未実施（要件定義時）

❌ 作業終了時の必須3ステップが未完了
   - コミットしていない
   - リモートにpushしていない
   - PR未作成
```

### 完了報告前の確認リスト

```
✅ すべてのテストがパスしている
✅ 型チェックがパスしている
✅ ビルドが成功している
✅ 専門エージェントレビューが完了している
✅ 設計書を更新している（該当する場合）
✅ コミット・push・PR作成が完了している
✅ ユーザーへの報告内容を準備している
```

---

## 👥 専門エージェント活用ガイド

### 📋 利用可能なエージェント

| エージェント | 役割 | 呼び出しタイミング |
|------------|------|------------------|
| **tech-lead** | コード品質レビュー | コード改修後、設計書更新後 |
| **qa-engineer** | テストコードレビュー | テストコード作成・修正時 |
| **product-manager** | 要件定義・仕様策定 | 新機能企画、仕様策定時 |
| **designer** | UI/UXデザインレビュー | UI/UX実装時（必須） |

### 🔧 呼び出し方法

```
Task toolで専門エージェントを呼び出し：

例1: コード改修後のレビュー
"tech-lead エージェントに以下の変更をレビューしてもらってください：
[変更内容の説明]"

例2: テストコードレビュー
"qa-engineer エージェントに以下のテストコードをレビューしてもらってください：
[テストファイルのパス]"

例3: 要件定義
"product-manager エージェントに以下の新機能の要件定義を依頼してください：
[機能の概要]"

例4: UI/UXデザインレビュー
"designer エージェントに以下のUI/UX実装をレビューしてもらってください：
[対象画面・コンポーネント]"
```

### 📝 レビューフロー

```
1. コード実装完了
   ↓
2. UI/UX実装の場合 → designer エージェントにレビュー依頼（必須）
   ↓
3. tech-lead エージェントにレビュー依頼
   ↓
4. 指摘事項を修正
   ↓
5. （テストコード修正した場合）qa-engineer エージェントにレビュー依頼
   ↓
6. 最終確認
   ↓
7. ユーザーに完了報告
```

---

## 📋 設計書管理ルール (MUST)

**重要**: コード改修前に必ず設計書の更新要否を判断

### 設計書の定義
```
このプロジェクトの設計書:
├── docs/design/             # 設計ドキュメント
│   ├── architecture.md      # アーキテクチャ設計
│   ├── ui-ux-improvement-plan.md  # UI/UX改善計画
│   ├── tide-system-master-spec.md # 潮汐システム仕様
│   └── [機能別設計書]
├── README.md                # プロジェクト概要・使い方
├── docs/current-status-and-roadmap.md  # 現状とロードマップ
└── .claude/CLAUDE.md        # 開発ガイドライン（このファイル）
```

### 設計書更新が必要なケース
```
以下のいずれかに該当する場合は設計書を更新:
✅ 新しいアーキテクチャパターンを導入
✅ 既存の設計方針を変更
✅ 新しいサービス層を追加
✅ UI/UX の構造を変更
✅ データモデルを変更
✅ 外部API連携を追加・変更
✅ パフォーマンス最適化の実装（記録として残す価値がある場合）
```

### 設計書更新プロセス
```
1. 関連する設計書を特定
2. 変更内容を明確に記述（変更理由も含む）
3. 影響範囲を記載
4. tech-lead エージェントにレビュー依頼
```

---

## 👤 完了確認

**全ての改修完了後、必ず以下を実施:**

```
1. 上記の完了報告前確認リストをすべてクリア
2. 専門エージェントレビューを完了
   - UI/UX実装時: designer（必須）→ tech-lead（必須）
   - コード改修時: tech-lead
   - テストコード修正時: qa-engineer
   - 要件定義時: product-manager
3. テスト実行: npm run test:fast
4. 型チェック: npm run typecheck
5. ユーザーに以下を報告:
   - 実施した改修内容
   - 更新した設計書（該当する場合）
   - 専門エージェントレビュー結果
   - テスト結果

★ ユーザーからの確認・承認を得てから次のタスクへ進む
```

---

## 🧪 テスト戦略

- **単体テスト**: サービス層の主要メソッド
- **コンポーネントテスト**: ユーザー操作フロー
- **E2Eテスト**: クリティカルパス（記録作成→表示→削除）
- **カバレッジ目標**: 70%以上

---

## 🚀 デプロイ前確認

```bash
# MUST: 全テストパス
npm run test:ci

# MUST: 型チェックパス
npm run typecheck

# MUST: ビルド成功
npm run build

# SHOULD: Lighthouse実行
npm run lighthouse
```

---

## 💡 トラブルシューティング

### テスト失敗時
1. `npm run test:ui` でUI確認
2. メモリ不足なら `NODE_OPTIONS='--max-old-space-size=4096' npm test`

### IndexedDB問題
1. Chrome DevTools > Application > Clear Storage
2. `window.indexedDB.deleteDatabase('BiteNoteDB')`

### パフォーマンス問題
1. `npm run build:analyze` でバンドルサイズ確認
2. React DevTools Profilerで再レンダリング確認

---

現在フェーズ: v1.5.0 データ検証機能強化完了
次期目標: PWA対応完全化、テストカバレッジ70%達成
