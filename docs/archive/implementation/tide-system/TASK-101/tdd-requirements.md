# TASK-101: 天体計算エンジン - 要件定義

## 概要

Zero API Dependency 潮汐システムの基盤となる高精度天体計算エンジンを実装する。
月齢・太陽月位置計算により、潮汐予測の基礎データを提供する。

## 詳細要件

### 機能要件

#### 1. 月齢計算機能
- **目的**: 潮汐タイプ判定（大潮・小潮等）の基礎データ提供
- **アルゴリズム**: ニューカム公式による高精度計算
- **基準点**: J2000.0新月 (2000-01-06T18:14:00Z)
- **朔望月**: 29.530588853日（天文学的標準値）
- **入力**: Date オブジェクト
- **出力**: 月齢（0-29.53日）、月相フェーズ、照度

#### 2. 太陽地心位置計算
- **目的**: 潮汐調和解析での太陽引力項計算
- **理論**: VSOP87簡略版（精度vs計算速度のバランス）
- **座標系**: 地心黄道座標系
- **出力**: 太陽地心経度・緯度（度）

#### 3. 月地心位置計算
- **目的**: 潮汐調和解析での月引力項計算
- **理論**: ELP2000簡略版（主要項のみ）
- **座標系**: 地心黄道座標系
- **出力**: 月地心経度・緯度・距離

#### 4. 天体角度関係計算
- **太陽-月角度**: 潮汐タイプ判定用
- **近地点・遠地点効果**: 潮汐強度補正用

### 非機能要件

#### パフォーマンス
- **計算時間**: 50ms以内/回
- **メモリ使用量**: 最小限（計算のみ、キャッシュなし）
- **精度**: 釣り用途に十分（月齢±0.1日、位置±1度）

#### 信頼性
- **入力検証**: 不正な日付の適切な処理
- **数値安定性**: 三角関数の適切な正規化
- **エラーハンドリング**: 計算失敗時のグレースフルフォールバック

## 受け入れ基準

### 月齢計算
- [ ] 2024年の新月・満月日が天文年鑑と±0.1日以内で一致
- [ ] 月相フェーズ（8段階）が正確に判定される
- [ ] 照度計算が0-1の範囲で適切に出力される

### 太陽位置計算
- [ ] 春分・夏至・秋分・冬至の太陽経度が理論値と±1度以内
- [ ] 年間を通じた太陽経度変化が滑らかな曲線を描く
- [ ] 計算結果が0-360度の範囲で正規化される

### 月位置計算
- [ ] 主要な満月・新月時の月経度が理論値と±1度以内
- [ ] 月地心距離が現実的範囲（35-41万km）内
- [ ] 月軌道の楕円性が適切に反映される

### パフォーマンス
- [ ] 単一日付の全天体計算が50ms以内
- [ ] 1年分（365日）の計算が5秒以内
- [ ] メモリリークが発生しない

### 統合性
- [ ] TypeScript型定義と完全に一致
- [ ] エラー時も適切な型で応答
- [ ] 他の潮汐計算モジュールから利用可能

## API仕様

```typescript
// メインクラス
class CelestialCalculator {
  // 月齢計算
  calculateMoonPhase(date: Date): MoonPhase

  // 天体位置計算
  calculateCelestialPositions(date: Date): CelestialPosition

  // 統合計算（最適化版）
  calculateAll(date: Date): {
    moonPhase: MoonPhase;
    positions: CelestialPosition;
  }
}

// ユーティリティ関数
function normalizeAngle(angle: number): number
function julianDay(date: Date): number
function meanLongitude(jd: number, period: number, epoch: number): number
```

## 実装制約

### ライブラリ依存
- **禁止**: 外部天文計算ライブラリ（完全自前実装）
- **許可**: 標準Math関数のみ
- **理由**: Zero API Dependency方針遵守

### 精度vs速度のトレードオフ
- **方針**: 釣り用途に十分な精度で最高速度
- **具体策**: 主要項のみの簡略計算、ルックアップテーブル活用

### 保守性
- **コメント**: 天文学的背景の詳細説明
- **テスト**: 天文年鑑データとの比較検証
- **分離**: 各天体の計算ロジックを独立化

## 参考資料

### 天文学的基準
- 天文年鑑2024（日本天文学会）
- Astronomical Almanac
- VSOP87理論（太陽系天体位置）
- ELP2000理論（月位置）

### 実装参考
- Meeus, J. "Astronomical Algorithms"
- NASA JPL Ephemeris データ
- IAU天文定数

## リスク評価

### 高リスク
- **計算精度不足**: 実測値との継続的比較で対応
- **パフォーマンス問題**: プロファイリングによる最適化

### 中リスク
- **数値計算の不安定性**: 適切な正規化処理で対応
- **境界値での誤差**: エッジケースの詳細テスト

### 低リスク
- **メモリ使用量**: 計算のみなので影響軽微
- **ブラウザ互換性**: 標準Math関数のみなので安全