# TASK-102: 調和解析エンジン - 要件定義（Requirements Phase）

## 概要
天体計算エンジン（TASK-101）の結果を基に、潮汐の調和解析理論を実装。
主要分潮による潮位計算、満潮・干潮時刻の検出、潮汐強度の算出を行う。

## 機能要件

### FR-102-01: 分潮定義システム
- **説明**: 主要6分潮（M2, S2, K1, O1, Mf, Mm）の定義と管理
- **詳細**:
  - 各分潮の角周波数（degrees/hour）定義
  - 分潮名、周期、分類（半日周、日周、長周期）管理
  - 分潮係数（f, u）の計算
- **受け入れ基準**:
  - [ ] M2分潮: 28.984104°/hour ±0.000001精度
  - [ ] 6分潮全ての角周波数が定義されている
  - [ ] 分潮係数が天体位置から正しく計算される

### FR-102-02: 潮位計算エンジン
- **説明**: 調和解析による潮位計算
- **詳細**:
  - 計算式: `tideLevel = Σ(Ai × Hi × cos(fi × t + φi + Vi))`
  - パラメータ:
    - Ai: 調和定数（振幅）
    - Hi: 分潮係数
    - fi: 角周波数
    - t: 時刻（時間単位）
    - φi: 位相差
    - Vi: 天文引数
- **受け入れ基準**:
  - [ ] 各分潮の寄与が正しく計算される
  - [ ] 合成潮位が±10cm精度で計算される
  - [ ] 計算速度が1時刻あたり<1ms

### FR-102-03: 満潮・干潮検出システム
- **説明**: 潮位の極値（満潮・干潮）時刻の検出
- **詳細**:
  - 潮位の1次微分を用いた極値検出
  - 満潮・干潮の分類と時刻記録
  - 連続する極値間の時間間隔検証
- **受け入れ基準**:
  - [ ] 満潮時刻が±10分精度で検出される
  - [ ] 干潮時刻が±10分精度で検出される
  - [ ] 24時間で2-4回の満潮・干潮が検出される

### FR-102-04: 潮汐強度計算システム
- **説明**: 潮の勢いの強さを数値化
- **詳細**:
  - 潮位変化率の計算（cm/hour）
  - 満潮・干潮からの時間差による強度補正
  - 0-10スケールでの強度表現
- **受け入れ基準**:
  - [ ] 潮位変化率が正しく計算される
  - [ ] 強度スケールが直感的に理解できる
  - [ ] 大潮・小潮の差が適切に反映される

## 非機能要件

### NFR-102-01: パフォーマンス
- 単一時刻計算: <1ms
- 24時間分計算: <100ms
- 1年分計算: <10秒

### NFR-102-02: 精度
- 潮位計算: ±10cm（相対精度）
- 満潮・干潮時刻: ±10分
- 分潮角周波数: ±0.000001°/hour

### NFR-102-03: 拡張性
- 分潮の追加・削除が容易
- 地域別パラメータの対応準備
- 異なる調和定数セットの対応

## 技術要件

### TR-102-01: インターフェース設計
```typescript
interface HarmonicAnalysisEngine {
  // 基本計算
  calculateTideLevel(dateTime: Date, harmonicConstants: HarmonicConstant[]): number;

  // 極値検出
  findTidalExtremes(startDate: Date, endDate: Date): TidalExtreme[];

  // 潮汐強度
  calculateTideStrength(dateTime: Date): TideStrength;

  // 分潮管理
  getConstituentFrequency(name: string): number;
  calculateConstituentFactors(dateTime: Date): ConstituentFactor[];
}
```

### TR-102-02: データ構造
```typescript
interface TidalConstituent {
  name: string;           // 'M2', 'S2', etc.
  frequency: number;      // degrees/hour
  period: number;         // hours
  type: 'semidiurnal' | 'diurnal' | 'long_period';
}

interface HarmonicConstant {
  constituent: string;
  amplitude: number;      // cm
  phase: number;         // degrees
}

interface TidalExtreme {
  dateTime: Date;
  level: number;         // cm
  type: 'high' | 'low';
}

interface TideStrength {
  value: number;         // 0-10 scale
  rate: number;          // cm/hour
  direction: 'rising' | 'falling';
}
```

### TR-102-03: 依存関係
- **TASK-101**: CelestialCalculator（天文引数V, 分潮係数f,u計算用）
- **astronomical-constants.ts**: 天文定数の利用
- **celestial-utils.ts**: 角度・時刻変換ユーティリティ

## 入力・出力仕様

### 入力
1. **日時**: Date型（UTC）
2. **調和定数**: HarmonicConstant[] - 各分潮の振幅・位相
3. **期間**: 開始日時〜終了日時（極値検出用）

### 出力
1. **潮位**: number（cm、平均海面基準）
2. **満潮・干潮**: TidalExtreme[]（時刻・潮位・種別）
3. **潮汐強度**: TideStrength（数値・変化率・方向）

## テスト要件

### UT-102-01: 分潮定義テスト
- 各分潮の角周波数精度
- 分潮周期の整合性
- 分潮係数計算の正確性

### UT-102-02: 潮位計算テスト
- 単一分潮の計算精度
- 複数分潮の合成計算
- 境界値（0時、24時）での連続性

### UT-102-03: 極値検出テスト
- 満潮・干潮の検出精度
- 連続する極値の妥当性
- 異常値の除外

### UT-102-04: 潮汐強度テスト
- 変化率計算の精度
- 強度スケールの妥当性
- 大潮・小潮での差異

### IT-102-01: 統合テスト
- 天体計算エンジンとの連携
- 24時間連続計算
- 実測データとの比較検証

## 制約・前提条件

### 制約
- 調和定数は外部から提供される（地域データベース未実装）
- 初期実装は標準的な6分潮のみ対応
- 地域特性（浅海効果等）は後続タスクで対応

### 前提条件
- TASK-101（天体計算エンジン）が完了している
- 基本的な調和定数データが準備されている
- TypeScript型定義が利用可能

## 品質基準

### 計算精度
- 理論値との相対誤差: <5%
- 実測データとの比較: RMSE <20cm（標準的な港湾）

### コード品質
- TypeScript型安全性: 100%
- テストカバレッジ: >90%
- ESLint警告: 0件

### パフォーマンス
- メモリ使用量: <10MB（1年分計算）
- CPU使用率: <50%（計算中）

## 成功基準

✅ **Phase 1完了基準**
- [ ] 全ての単体テストが通過
- [ ] 統合テストが通過
- [ ] パフォーマンス要件を満たす
- [ ] コード品質基準を満たす

✅ **Phase 2完了基準**（後続タスクとの連携）
- [ ] TASK-103（潮汐予測エンジン）で利用可能
- [ ] 地域データベース（TASK-201）と連携可能
- [ ] UIコンポーネントで表示可能

## 実装方針

### アーキテクチャ
- 責任分離: 分潮定義・潮位計算・極値検出を分離
- 拡張性: インターフェース駆動設計
- テスタビリティ: 純粋関数中心の設計

### 開発アプローチ
1. **分潮定義**: 基本的な6分潮から開始
2. **潮位計算**: 単一分潮→複数分潮の順で実装
3. **極値検出**: 数値微分による基本アルゴリズム
4. **強度計算**: 変化率ベースの実装

### エラーハンドリング
- 不正な日時: 適切なエラーメッセージ
- 不足する調和定数: デフォルト値または警告
- 計算オーバーフロー: 境界値チェック

## Next Steps
Requirements Phase完了後、テストケース設計（tdd-testcases.md）に進む。