# 潮汐グラフ改善 アーキテクチャ設計

## システム概要

釣果記録アプリケーションの潮汐グラフ機能において、座標・日時に基づく個別の潮汐計算と軸ラベル表示の改善を実施。既存のフロントエンド主体アーキテクチャを基盤とし、潮汐計算エンジンとグラフ描画機能の機能強化を行う。

## アーキテクチャパターン

- **パターン**: レイヤードアーキテクチャ（Presentation層 → Service層 → Data層）
- **理由**: 既存システムとの整合性を保ちつつ、潮汐計算ロジックを独立した層として管理可能

## システム境界

### スコープ内
- 潮汐計算サービスの機能拡張
- グラフ描画コンポーネントの改善
- 地域データサービスとの統合
- レスポンシブ表示の最適化

### スコープ外
- 新規APIエンドポイントの追加
- データベーススキーマの変更
- 認証・認可システムの変更

## コンポーネント構成

### フロントエンド層（Presentation Layer）

#### UI Components
- **TideGraph.tsx** - メインのグラフ描画コンポーネント
  - フレームワーク: React + TypeScript
  - グラフライブラリ: recharts (LineChart, Line, XAxis, YAxis)
  - 状態管理: React hooks (useState, useMemo, useCallback)
  - レスポンシブ: カスタムフック useResize

#### Integration Components
- **TideIntegration.tsx** - 潮汐データ統合コンポーネント
  - 釣果記録データとの連携
  - 潮汐計算サービスとの通信
  - エラーハンドリングとローディング状態管理

### サービス層（Service Layer）

#### Core Services
- **TideCalculationService.ts** - 潮汐計算の中核サービス
  - 座標・日時による個別計算
  - 季節変動・月齢効果の反映
  - キャッシュ管理（座標・日時組み合わせキー）

#### Domain Services
- **RegionalDataService.ts** - 地域データ管理サービス
  - 座標に基づく最適地域選択
  - 調和定数の動的調整
  - 地域間補間処理

- **HarmonicAnalysisEngine.ts** - 調和解析エンジン
  - 分潮計算（M2, S2, K1, O1）
  - 高次分潮（M4, MS4）の計算
  - 潮汐予測アルゴリズム

#### Utility Services
- **ScaleRenderer.ts** - スケール描画ユーティリティ
  - 動的Y軸スケール計算
  - 軸ラベル最適化
  - SVGマージン計算

- **ResponsiveUtils.ts** - レスポンシブユーティリティ
  - 画面サイズ対応
  - SVG寸法計算
  - デバイス種別判定

### データ層（Data Layer）

#### Data Sources
- **RegionalTideData** - 地域別潮汐データ
  - 50地域の観測点データ
  - 調和定数（M2, S2振幅・位相）
  - 地理的座標情報

#### Cache Management
- **TideCalculationCache** - 計算結果キャッシュ
  - キー: `${緯度}_${経度}_${日時ISO}`
  - LRU方式によるメモリ管理
  - 有効期限: 24時間

## データフロー

### 潮汐グラフ表示フロー
```
釣果記録データ → TideIntegration → TideCalculationService → 座標・日時分析
                                                           ↓
RegionalDataService ← 地域データ選択 ← HarmonicAnalysisEngine ← 調和解析
                                                           ↓
TideGraph ← グラフデータ ← ScaleRenderer ← 24時間潮位データ生成
```

### レスポンシブ表示フロー
```
画面サイズ変更 → useResize → ResponsiveUtils → SVG寸法計算 → TideGraph再描画
```

## 技術スタック

### フロントエンド
- **言語**: TypeScript 4.9+
- **フレームワーク**: React 18
- **状態管理**: React hooks
- **グラフライブラリ**: recharts
- **スタイリング**: Tailwind CSS
- **バンドラー**: Vite

### 開発・テスト
- **テストフレームワーク**: Vitest + React Testing Library
- **型チェック**: TypeScript strict mode
- **リンター**: ESLint + Prettier
- **パッケージマネージャー**: npm

## 非機能要件対応

### パフォーマンス
- 潮汐計算: 2秒以内（キャッシュヒット率50%以上）
- グラフ描画: 初期1秒、再描画500ms以内
- メモリ使用量: キャッシュ最大100エントリ

### 精度
- 座標による潮汐差: 実測値との誤差±20%以内
- 季節変動反映: 月単位での変動表現
- 軸ラベル表示: 100%の表示保証

### ユーザビリティ
- レスポンシブ対応: 320px〜4K解像度
- アクセシビリティ: WCAG 2.1 AA準拠
- エラー表示: 非技術者向けメッセージ

## セキュリティ考慮事項

### 入力検証
- 座標範囲: 緯度(-90〜90度)、経度(-180〜180度)
- 日時範囲: 計算可能期間内（1970-2050年）
- データ型検証: TypeScriptによる静的チェック

### XSS対策
- グラフデータのサニタイズ
- SVG出力の安全性確保
- DOMPurifyによるHTMLサニタイズ

## 拡張性・保守性

### モジュール分離
- 潮汐計算ロジックの独立性
- グラフ描画の再利用性
- 地域データの追加容易性

### 設定管理
- 環境変数による設定外部化
- フィーチャーフラグによる段階展開
- ログレベルの動的調整

### 国際化対応
- 多言語対応の準備
- 地域固有の潮汐表記
- タイムゾーン対応

---

**設計日**: 2025-09-28
**設計者**: 潮汐システム開発チーム
**レビュー者**: アーキテクト