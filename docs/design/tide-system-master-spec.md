# 潮汐システム 実装完了仕様書

> **実装済み潮汐システムの概要** - Bite Note 潮汐情報システム
>
> **最終更新**: 2025年10月30日
> **バージョン**: v1.1
> **ステータス**: 実装完了・動作確認済

## 📋 概要

**完全無料・オフライン対応**の潮汐情報システム。釣果記録に自動で潮汐情報を付与し、釣り人が「いつ釣れたのか」と「その時の潮の状態」を直感的に理解できます。

### 主要特徴

- ✅ **完全無料**: API料金・ライセンス費用ゼロ
- ✅ **オフライン動作**: ネットワーク不要
- ✅ **リアルタイム計算**: 初回200ms以内、キャッシュ10ms以内
- ✅ **5種類の潮汐タイプ**: 大潮・中潮・小潮・長潮・若潮を自動判定
- ✅ **満潮・干潮時刻予測**: 24時間の潮汐イベント表示
- ✅ **潮汐グラフ表示**: インタラクティブな24時間グラフ
- ✅ **月齢・月相表示**: 天体情報の可視化

---

## 🏗️ アーキテクチャ

### 3層構造

```
UI Layer (潮汐グラフ・サマリーカード)
    ↓
Business Logic Layer (潮汐予測・タイプ判定)
    ↓
Calculation Engine Layer (天体計算・調和解析・地域補正)
```

### 計算エンジン

1. **天体計算エンジン**
   - 月齢計算（ニューカム公式）
   - 太陽・月位置計算
   - 朔望月: 29.530588853日

2. **調和解析エンジン**
   - 主要6分潮（M2, S2, K1, O1, Mf, Mm）
   - 潮位計算・満潮干潮検出

3. **地域補正システム**
   - 日本沿岸50箇所のデータ
   - 振幅・位相補正
   - 地形効果（浅海・湾・海峡）

---

## 🎯 潮汐分類システム

### 5種類の潮汐タイプ判定

月齢に基づいて5種類の潮汐タイプを自動判定します：

| 潮汐タイプ | 月齢範囲 | 特徴 |
|----------|---------|------|
| **大潮** | 0～2.5日、12.0～17.5日、27.5～29.53日 | 新月・満月付近、潮位差最大 |
| **中潮** | 2.5～5.5日、17.5～20.0日 | 大潮と小潮の移行期 |
| **小潮** | 5.5～9.0日、20.0～24.0日 | 上弦・下弦付近、潮位差最小 |
| **長潮** | 9.0～10.5日、24.0～25.5日 | 小潮の後、潮位差が長く最小 |
| **若潮** | 10.5～12.0日、25.5～27.5日 | 長潮の後、潮位差増加開始 |

**判定精度**:
- 満月（望）= 月齢14.77日
- 新月（朔）= 月齢0.00日
- 実際の潮汐カレンダーとの照合により検証済み
- 2025年10月に精度向上版を実装

### 潮汐強度

月・太陽の合成効果による潮汐強度を0-100%で表示します。

---

## 📊 データ構造

### 潮汐情報（TideInfo）

釣果記録に付与される潮汐情報：

```typescript
interface TideInfo {
  moonAge: number;           // 月齢（0-29.53）
  moonPhase: string;         // 月相（新月・上弦・満月・下弦）
  tideType: string;          // 潮汐タイプ（大潮・中潮・小潮・長潮・若潮）
  tideStrength: number;      // 潮汐強度（0-100%）
  highTides: TideEvent[];    // 満潮時刻のリスト
  lowTides: TideEvent[];     // 干潮時刻のリスト
}

interface TideEvent {
  time: string;              // イベント時刻
  height: number;            // 潮位（メートル）
}
```

### 釣果記録との統合

釣果記録作成時に自動で潮汐情報を付与：

```typescript
interface FishingRecord {
  id: string;
  date: Date;
  location: string;
  coordinates?: Coordinates;
  tideInfo?: TideInfo;       // 自動付与される潮汐情報
  // ... その他のフィールド
}
```

---

## 🎨 UI/UX実装

### 潮汐グラフ（TideGraph）

24時間の潮位変化をSVGで表示するインタラクティブグラフ：

- **表示内容**:
  - 潮位曲線（SVGパス）
  - 満潮・干潮マーカー
  - 釣れた時刻マーカー
  - 時刻軸（0:00～24:00）
  - グリッドライン

- **インタラクション**:
  - ホバー/タップで詳細表示
  - スムーズアニメーション
  - レスポンシブサイズ調整

### 潮汐サマリーカード

釣果記録詳細画面に表示される4項目グリッド：

1. 潮汐タイプ（大潮・中潮等）
2. 月齢・月相
3. 満潮・干潮時刻
4. 潮汐強度（%）

### モバイル対応

- **レスポンシブデザイン**: モバイル/タブレット/デスクトップ
- **タッチ操作**: 最小タッチターゲット44px
- **パフォーマンス**: SVG最適化、GPU加速アニメーション

---

## ⚡ パフォーマンス

### キャッシュ戦略

**LRUキャッシュ（IndexedDB永続化）**:
- キャッシュキー: `緯度,経度,日付`（小数点2桁丸め）
- 最大100エントリ
- 自動期限切れ（30日）

### 実測パフォーマンス

| 操作 | 時間 |
|------|------|
| 初回潮汐計算 | < 200ms |
| キャッシュヒット | < 10ms |
| グラフレンダリング | < 300ms |
| インタラクション | < 16ms (60fps) |

### 最適化施策

- ✅ LRUキャッシュによる再計算防止
- ✅ SVG要素数の最小化
- ✅ CSS transformsによるGPU加速
- ✅ 遅延読み込み（React.lazy）

---

## 📚 実装ファイル

### サービス層

- **`src/services/tide/TideCalculationService.ts`** - メイン計算サービス
- **`src/services/tide/TideTypeCalculator.ts`** - 潮汐タイプ判定
- **`src/services/tide/TideEventCalculator.ts`** - 満潮・干潮計算
- **`src/services/tide/MoonPhaseCalculator.ts`** - 月齢・月相計算
- **`src/services/tide/TideCache.ts`** - LRUキャッシュ

### UIコンポーネント

- **`src/components/tide/TideGraph.tsx`** - メイングラフ
- **`src/components/tide/TideSummaryCard.tsx`** - サマリーカード
- **`src/components/tide/TideEventsList.tsx`** - イベント一覧

### 型定義

- **`src/types/tide.ts`** - 全潮汐関連型定義

---

## 🎯 まとめ

**Bite Note潮汐システム**は、完全無料・オフライン対応のリアルタイム潮汐予測システムです。

### 主要な特徴

1. **完全無料** - API料金ゼロ
2. **オフライン動作** - ネットワーク不要
3. **高速計算** - 初回200ms以内、キャッシュ10ms以内
4. **5種類の潮汐タイプ** - 精度検証済み
5. **美しいUI** - インタラクティブグラフ

### 技術的成果

- 天文学的計算による高精度予測
- LRUキャッシュによる高速化
- IndexedDB永続化
- モバイル最適化

---

**最終更新**: 2025年10月30日
**バージョン**: v1.1
**ステータス**: 実装完了・動作確認済