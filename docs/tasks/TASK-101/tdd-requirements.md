# TASK-101: 動的縦軸スケール調整機能 - 要件定義

## 概要

潮汐グラフの縦軸スケールを潮位データに基づいて動的に調整する機能を実装します。これにより、異なる座標・日時での潮汐グラフが視覚的に区別可能になり、各釣果記録に適切なスケール表示を提供します。

## 機能要件

### FR-101: 動的スケール計算エンジン

**目的**: 潮位データの最小値・最大値を分析し、最適な縦軸スケールを自動計算する

**要件**:
- 潮位データ配列から最小値・最大値を抽出
- 適切なマージンを考慮した表示範囲の計算
- 目盛り間隔の自動調整（0.5m, 1.0m, 2.0m, 5.0mから最適値を選択）
- データ範囲に基づく動的な目盛り数の決定（6-10個の範囲）

**入力**:
```typescript
interface TideDataPoint {
  time: string;
  level: number; // 潮位（メートル）
  state: 'rising' | 'falling' | 'high' | 'low';
}

interface TideGraphData {
  points: TideDataPoint[];
  // ... 他のプロパティ
}
```

**出力**:
```typescript
interface DynamicScale {
  min: number;        // 表示範囲の最小値
  max: number;        // 表示範囲の最大値
  interval: number;   // 目盛り間隔
  ticks: number[];    // 目盛り値の配列
  unit: string;       // 単位（"m"）
}
```

### FR-102: スケール適応ロジック

**目的**: データの特性に応じたスケール調整戦略を実装

**要件**:
- **狭い範囲データ**: 潮位差が2m未満の場合、0.5m間隔での細かい表示
- **中間範囲データ**: 潮位差が2-5mの場合、1.0m間隔での標準表示
- **広い範囲データ**: 潮位差が5m以上の場合、2.0m以上の間隔での広域表示
- **マージン計算**: データ範囲の10-20%のマージンを上下に追加
- **ゼロ基準調整**: 平均海面付近のデータの場合、ゼロを含むスケール調整

### FR-103: スケール表示の統合

**目的**: TideGraphコンポーネントでの動的スケール表示

**要件**:
- SVGのY軸座標系への変換計算
- 目盛りラベルの動的生成
- グリッドラインの動的配置
- 既存のレスポンシブ機能との統合

## 非機能要件

### NFR-101: パフォーマンス

- スケール計算時間: 10ms以内
- メモリ使用量: 追加で1MB以内
- キャッシュ効率: 同一データでの再計算を回避

### NFR-102: 可用性

- 無効なデータに対する適切なフォールバック
- 極端な値（潮位差0.1m未満、20m以上）での安全な動作
- データ欠損時のデフォルトスケール提供

### NFR-103: 保守性

- スケール計算ロジックの分離
- 設定可能なパラメータ（マージン率、間隔選択肢など）
- 既存のTideCalculationServiceとの統合

## 受け入れ基準

### AC-101: 基本動作
- [ ] 潮位データから最小・最大値を正確に抽出できる
- [ ] データ範囲に応じて適切な目盛り間隔を選択する
- [ ] 計算されたスケールでSVG描画が正常に行われる

### AC-102: 視覚的品質
- [ ] 異なる潮位範囲のデータで視覚的に区別可能なスケール
- [ ] 目盛りラベルが重複せず、読みやすく配置される
- [ ] グリッドラインが適切な間隔で表示される

### AC-103: エラーハンドリング
- [ ] 空の配列や無効なデータでエラーが発生しない
- [ ] 極端な値でも安全にフォールバックする
- [ ] デバッグ情報が適切にログ出力される

### AC-104: 統合性
- [ ] 既存のTideGraphコンポーネントと統合できる
- [ ] レスポンシブ機能と併用できる
- [ ] 潮汐計算結果と整合性が保たれる

## テストケース概要

### 単体テスト
1. **スケール計算ロジック**
   - 正常なデータでの計算結果検証
   - 境界値での動作確認
   - 無効なデータでのフォールバック確認

2. **目盛り生成**
   - 間隔選択の妥当性確認
   - 目盛り数の範囲確認
   - ラベル文字列の正確性確認

### 統合テスト
1. **TideGraphとの統合**
   - 動的スケールでの正常な描画確認
   - 既存機能への影響確認
   - レスポンシブ対応との併用確認

### UIテスト
1. **視覚的検証**
   - 異なるデータセットでの表示差異確認
   - スケール変更時のアニメーション確認
   - 各デバイスサイズでの表示品質確認

## 実装ファイル計画

### 新規作成
- `src/utils/scale/DynamicScaleCalculator.ts` - スケール計算エンジン
- `src/utils/scale/ScaleRenderer.ts` - スケール描画ユーティリティ
- `src/types/scale.ts` - スケール関連の型定義

### 更新対象
- `src/components/TideGraph.tsx` - 動的スケール統合
- `src/types/tide.ts` - 型定義の拡張

### テストファイル
- `src/__tests__/utils/scale/DynamicScaleCalculator.test.ts`
- `src/__tests__/utils/scale/ScaleRenderer.test.ts`
- `src/__tests__/components/TideGraph.dynamic-scale.test.tsx`

## 設計考慮事項

### アーキテクチャ
- **責任分離**: スケール計算とレンダリングを分離
- **拡張性**: 将来的なスケールタイプの追加に対応
- **統合性**: 既存のユーティリティとの整合性保持

### パフォーマンス最適化
- **計算結果のメモ化**: useMemoを活用した再計算回避
- **最小限の再描画**: スケール変更時のみの部分更新
- **効率的なデータ処理**: 配列操作の最適化

### エラー回復戦略
- **段階的フォールバック**: より安全なデフォルト値への段階的切り替え
- **ユーザーフィードバック**: スケール調整の状態表示
- **デバッグサポート**: 開発時のスケール計算情報表示

---

**作成日**: 2024-09-25
**担当者**: 開発チーム
**レビュー者**: プロダクトオーナー