# 潮汐グラフの改善 要件定義書

## 概要

釣果記録アプリケーションの潮汐グラフ機能において、異なる日時・場所の釣果記録にも関わらず、グラフの縦軸スケールと波形が常に同一となる不具合の修正を実施する。各釣果記録固有の座標・日時に基づいた個別の潮汐パターンを正確に表示し、ユーザーが釣果と潮汐の関係性を適切に分析できるようにする。

## 問題の詳細

### 現在の問題
- **アジ（15:32）**: 縦軸0-24cm、波形パターンが同一
- **ネリゴ（23:06）**: 縦軸0-23cm、波形パターンが同一
- **ぶり（山口県下関市）**: 縦軸0-25cm、波形パターンが同一

異なる場所（座標）・時刻・魚種にも関わらず、潮汐グラフの表示内容が実質的に同一となっている。

## ユーザストーリー

### ストーリー1: 個別潮汐パターンの表示

- **である** 釣り人 **として**
- **私は** 各釣果記録の実際の座標と日時に基づいた固有の潮汐グラフ **を見たい**
- **そうすることで** その場所・時刻特有の潮汐条件と釣果の関係性を正確に分析できる

### ストーリー2: 場所による潮汐差の可視化

- **である** 釣り分析者 **として**
- **私は** 異なる釣り場の潮汐パターンの違い **を比較したい**
- **そうすることで** 場所ごとの最適な釣行タイミングを見極めることができる

### ストーリー3: 日時による潮汐変動の表示

- **である** 釣果記録ユーザー **として**
- **私は** 同じ場所でも異なる日時の潮汐パターンの違い **を確認したい**
- **そうすることで** 季節や月齢による潮汐変動の影響を理解できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは各釣果記録の実際の座標（緯度・経度）を潮汐計算に使用しなければならない
- REQ-002: システムは各釣果記録の実際の日時を潮汐計算に使用しなければならない
- REQ-003: システムは座標に基づいて最適な地域データを選択し、潮汐計算に反映しなければならない
- REQ-004: システムは日時に基づいて季節変動や月齢効果を潮汐計算に反映しなければならない
- REQ-005: システムは座標間の距離に応じて異なる調和定数を適用しなければならない

### 条件付き要件

- REQ-101: 座標が異なる場合、システムは地域特性に応じて振幅・位相を調整しなければならない
- REQ-102: 日付が異なる場合、システムは季節変動係数を調整しなければならない
- REQ-103: 月齢が異なる場合、システムは潮汐強度と分類を再計算しなければならない
- REQ-104: 地域データが見つからない場合、システムは最寄りの観測点データを補間使用しなければならない

### 状態要件

- REQ-201: キャッシュが存在する場合、システムは座標・日時の組み合わせごとに個別のキャッシュキーを使用しなければならない
- REQ-202: 同一座標・同一日時の場合、システムはキャッシュされた結果を再利用してもよい

### オプション要件

- REQ-301: システムは地域固有の浅海効果や共鳴効果を考慮してもよい
- REQ-302: システムは高次分潮（M4、MS4等）を追加で計算してもよい
- REQ-303: システムは地形データ（水深、湾長等）を潮汐計算に組み込んでもよい

### 制約要件

- REQ-401: システムは座標の有効範囲（緯度-90〜90度、経度-180〜180度）内でのみ計算を実行しなければならない
- REQ-402: システムは計算結果のキャッシュ時間を座標・日時の組み合わせで管理しなければならない
- REQ-403: システムは各釣果記録で異なる潮汐パラメータを保持しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: 潮汐計算は各釣果記録で独立して実行され、2秒以内に完了しなければならない
- NFR-002: 座標・季節変動の計算オーバーヘッドは従来比50%以内に抑制しなければならない
- NFR-003: キャッシュヒット率は座標・日時の多様性に関わらず50%以上を維持しなければならない

### 精度

- NFR-101: 座標による潮汐差は実測値との誤差±20%以内でなければならない
- NFR-102: 季節変動の反映精度は月単位での変動を正しく表現しなければならない
- NFR-103: 地域補正の効果は隣接する観測点との差異を適切に反映しなければならない

### ユーザビリティ

- NFR-201: 各グラフは視覚的に区別可能な異なる波形パターンを表示しなければならない
- NFR-202: 縦軸スケールは潮位範囲に応じて自動調整されなければならない
- NFR-203: グラフの描画は既存のUIレイアウトを破綻させてはならない
- NFR-204: グラフは1画面に収まるように表示され、横スクロールを発生させてはならない
- NFR-205: グラフの横幅は画面サイズに応じてレスポンシブに調整されなければならない

## Edgeケース

### エラー処理

- EDGE-001: 座標が地域データベース範囲外の場合、最寄りの観測点を使用し警告を表示する
- EDGE-002: 日時が計算可能範囲外の場合、適切なエラーメッセージを表示する
- EDGE-003: 地域データが不完全な場合、デフォルト値で補間し精度警告を表示する
- EDGE-004: ネットワークエラーでデータ取得に失敗した場合、キャッシュデータで代替する

### 境界値

- EDGE-101: 座標精度の限界（小数点6桁）での計算精度を保証する
- EDGE-102: 日付境界（0時、月末）での連続性を保証する
- EDGE-103: 地域データベースの最大距離（1000km）での補間精度を保証する
- EDGE-104: キャッシュ容量上限でのデータ管理を適切に行う
- EDGE-105: 極小画面サイズ（320px幅）でもグラフが適切に表示される
- EDGE-106: 極大画面サイズ（4K解像度）でもグラフの比率が維持される

### データ整合性

- EDGE-201: 同一座標でも微小な差異がある場合の重複排除処理
- EDGE-202: 古いキャッシュデータと新計算ロジックとの整合性保証
- EDGE-203: 地域データ更新時の既存キャッシュとの整合性保証

## 技術的実装要件

### 座標変動係数

- TECH-001: 緯度35度、経度135度を基準とした変動係数計算式を実装する
- TECH-002: 座標差に基づく調和定数の動的調整機能を実装する

### 季節変動係数

- TECH-101: 春分（3/21）を基準とした年間季節角度計算を実装する
- TECH-102: 緯度による季節変動強度の調整機能を実装する
- TECH-103: 各分潮（M2、S2、K1、O1）への個別季節係数適用を実装する

### 分潮拡張

- TECH-201: K1、O1分潮の推定値計算機能を実装する
- TECH-202: 高次分潮（M4、MS4）の計算オプションを実装する

### キャッシュ改善

- TECH-301: 座標・日時組み合わせによる一意キー生成を実装する
- TECH-302: キャッシュエントリの適切な有効期限管理を実装する

### レスポンシブ表示

- TECH-401: グラフ幅の画面幅に対する自動調整機能を実装する
- TECH-402: SVGビューボックスの動的サイズ計算を実装する
- TECH-403: 横スクロール発生防止のためのオーバーフロー制御を実装する
- TECH-404: モバイル・タブレット・デスクトップでの最適表示を実装する

## 受け入れ基準

### 機能テスト

- [ ] 異なる座標の釣果記録で異なる潮汐グラフが表示される
- [ ] 異なる日時の釣果記録で異なる潮汐パターンが表示される
- [ ] 縦軸スケールが潮位範囲に応じて動的に調整される
- [ ] 座標変動係数が正しく計算・適用される
- [ ] 季節変動係数が正しく計算・適用される
- [ ] K1、O1分潮が適切に生成・適用される
- [ ] 地域データの選択が座標に基づいて正しく行われる
- [ ] キャッシュキーが座標・日時の組み合わせで一意に生成される

### 非機能テスト

- [ ] 各潮汐計算が2秒以内に完了する
- [ ] 計算オーバーヘッドが従来比50%以内に抑制される
- [ ] キャッシュヒット率が50%以上を維持する
- [ ] 座標による潮汐差が実測値との誤差±20%以内である
- [ ] 季節変動が月単位で正しく反映される

### レスポンシブ表示テスト

- [ ] スマートフォン（320px〜414px）で横スクロールが発生しない
- [ ] タブレット（768px〜1024px）で適切にグラフが表示される
- [ ] デスクトップ（1200px以上）で比率が維持される
- [ ] 画面回転時にグラフが正しく再描画される
- [ ] ズーム操作（50%〜200%）でレイアウトが破綻しない

### 回帰テスト

- [ ] 既存の潮汐計算機能に悪影響を与えない
- [ ] UIレイアウトが破綻しない
- [ ] TypeScriptコンパイルエラーが発生しない
- [ ] 既存テストが全て通過する

### エラーハンドリングテスト

- [ ] 範囲外座標でのエラー処理が適切に動作する
- [ ] 範囲外日時でのエラー処理が適切に動作する
- [ ] 地域データ不足時の補間処理が適切に動作する
- [ ] ネットワークエラー時のキャッシュ代替処理が適切に動作する

## 影響範囲

### 修正対象ファイル

- `src/services/tide/TideCalculationService.ts` - 座標・季節変動ロジックの実装
- `src/services/tide/RegionalDataService.ts` - 地域データ選択ロジックの確認
- `src/services/tide/HarmonicAnalysisEngine.ts` - 分潮計算の拡張
- `src/components/TideIntegration.tsx` - 潮汐データ統合の確認
- `src/components/TideGraph.tsx` - グラフ表示の動的スケール調整・レスポンシブ対応

### テスト対象

- 潮汐計算サービスの単体テスト
- 座標・季節変動ロジックの単体テスト
- 潮汐グラフコンポーネントの統合テスト
- 異なる座標・日時でのE2Eテスト

## 完了定義

1. 異なる釣果記録で視覚的に区別可能な潮汐グラフが表示される
2. 座標・日時に基づく個別計算が正常に機能する
3. 全ての受け入れ基準が満たされる
4. TypeScriptコンパイル及び既存テストが通過する
5. パフォーマンス要件が満たされる

---

---

## TASK-303: 潮汐グラフ描画要件改善（追加要件）

### 概要

前述の座標・日時による個別計算改善に加えて、潮汐グラフの描画機能そのものの改善を実施する。特に軸ラベルの表示、データ構造の標準化、エラーハンドリングの強化を図り、より信頼性の高いグラフ表示を実現する。

### ユーザストーリー

#### ストーリー4: 軸ラベルの確実な表示

- **である** 潮汐グラフ利用者 **として**
- **私は** X軸（時刻）とY軸（潮位）のラベルが常に見える状態でグラフを確認したい **をしたい**
- **そうすることで** グラフの値を正確に読み取り、潮汐パターンを適切に理解できる

#### ストーリー5: 一貫したデータ表示

- **である** アプリケーション利用者 **として**
- **私は** 統一されたライブラリとデータ形式で一貫したグラフ操作感を得たい **をしたい**
- **そうすることで** 学習コストを削減し、効率的にデータを分析できる

### 機能要件（EARS記法）- 描画改善

#### 通常要件（描画）

- REQ-501: システムは軸ラベル（時刻・潮位）が常に表示領域内に収まるよう描画しなければならない
- REQ-502: システムは潮汐データを配列形式（[{ time: "HH:mm", tide: 数値 }]）で処理しなければならない
- REQ-503: システムはrechartsライブラリ（LineChart, Line, XAxis, YAxis）を使用してグラフを描画しなければならない
- REQ-504: システムは時刻データを"HH:mm"形式（00:00〜23:59）で表示しなければならない
- REQ-505: システムは潮位データを数値（cm単位）で表示しなければならない

#### 条件付き要件（描画）

- REQ-601: データが空配列または1点以下の場合、システムは「データ未取得」メッセージを表示し、グラフを描画してはならない
- REQ-602: 潮位データがnullまたはundefinedの場合、システムは「データ未取得」メッセージを表示し、グラフを描画してはならない
- REQ-603: 時刻データが"HH:mm"形式でない場合、システムはデータ検証エラーを表示しなければならない
- REQ-604: 潮位データが数値でない場合、システムはデータ検証エラーを表示しなければならない
- REQ-605: SVGサイズが不足する場合、システムは最小表示サイズを保証しなければならない

#### 状態要件（描画）

- REQ-701: グラフが正常に表示されている状態で、システムは波形パターンを滑らかな曲線として描画しなければならない
- REQ-702: エラー状態において、システムは詳細なエラー情報をコンソールに出力しなければならない
- REQ-703: 軸ラベルが表示されている状態で、システムは十分な余白を確保しなければならない

#### 制約要件（描画）

- REQ-801: システムは単一値のループ表示を実装してはならない
- REQ-802: システムは棒グラフまたは円グラフを使用してはならない
- REQ-803: システムはrechartsライブラリ以外のグラフライブラリを使用してはならない
- REQ-804: システムは軸ラベルの最小マージン（X軸40px、Y軸60px）を確保しなければならない

### 非機能要件（描画）

#### パフォーマンス（描画）

- NFR-501: グラフの初期描画は1秒以内に完了しなければならない
- NFR-502: データ更新時のグラフ再描画は500ms以内に完了しなければならない
- NFR-503: 最大96ポイント（15分間隔×24時間）のデータを滑らかに描画できなければならない

#### ユーザビリティ（描画）

- NFR-601: 軸ラベルは12px以上のフォントサイズで表示しなければならない
- NFR-602: エラーメッセージは技術的でない言葉で表示しなければならない
- NFR-603: グラフは色覚多様性に配慮した色使いでなければならない
- NFR-604: 最小表示サイズ（幅600px、高さ300px）を下回らないこと

#### 互換性（描画）

- NFR-701: モダンブラウザ（Chrome, Firefox, Safari, Edge）で正常に動作しなければならない
- NFR-702: モバイルデバイスでの表示に対応しなければならない

### Edgeケース（描画）

#### エラー処理（描画）

- EDGE-401: ネットワークエラーによりデータ取得に失敗した場合の処理
- EDGE-402: APIから不正な形式のデータが返された場合の処理
- EDGE-403: JavaScriptエラーによりrechartsコンポーネントの初期化に失敗した場合の処理
- EDGE-404: SVGレンダリングエラーが発生した場合の処理

#### 境界値（描画）

- EDGE-501: 潮位データが異常に大きい値（例：10000cm）の場合の表示処理
- EDGE-502: 潮位データが負の値の場合の表示処理
- EDGE-503: 時刻データが24:00を超える場合の処理
- EDGE-504: データポイントが非常に多い（例：1000ポイント）場合のパフォーマンス
- EDGE-505: 極小画面サイズでの軸ラベル表示の保証

#### データ整合性（描画）

- EDGE-601: 時刻データが順序通りでない場合の処理
- EDGE-602: 重複する時刻データがある場合の処理
- EDGE-603: 時刻データに欠損がある場合の補間処理

### 技術的実装要件（描画）

#### データ構造標準化

- TECH-501: TideData インターフェース（time: string, tide: number）の実装
- TECH-502: データ検証ロジックの強化
- TECH-503: エラーハンドリングの統一化

#### 軸ラベル表示保証

- TECH-601: SVGマージン計算の最適化
- TECH-602: 動的サイズ調整機能の実装
- TECH-603: レスポンシブ表示の改善

#### rechartsコンポーネント最適化

- TECH-701: ResponsiveContainer の適切な設定
- TECH-702: LineChart コンポーネントの設定最適化
- TECH-703: 軸とグリッドの表示設定

### 受け入れ基準（描画）

#### 機能テスト（描画）

- [ ] 正常なデータで24時間の折れ線グラフが表示される
- [ ] X軸に時刻、Y軸に潮位が適切に表示される
- [ ] 軸ラベルが常に表示領域内に収まる
- [ ] 空データで「データ未取得」メッセージが表示される
- [ ] null/undefinedデータで「データ未取得」メッセージが表示される
- [ ] 不正形式データでエラーメッセージが表示される
- [ ] rechartsライブラリのコンポーネントが使用されている
- [ ] 棒グラフや円グラフが使用されていない
- [ ] 単一値のループ表示が実装されていない

#### 非機能テスト（描画）

- [ ] グラフの初期描画が1秒以内に完了する
- [ ] 軸ラベルが12px以上のフォントサイズで表示される
- [ ] エラーメッセージが分かりやすい言葉で表示される
- [ ] 最小表示サイズ（600x300px）が保証される
- [ ] モバイルデバイスで適切に表示される
- [ ] 主要ブラウザで正常に動作する

#### 統合テスト（描画）

- [ ] 既存の潮汐計算システムとの連携が正常に動作する
- [ ] 釣果記録詳細画面での表示が適切である
- [ ] レスポンシブレイアウトが正常に機能する
- [ ] 軸ラベル表示に関するテストが全て通過する

### 実装ガイドライン（描画）

#### データ構造の例

```typescript
interface TideData {
  time: string;  // "HH:mm" format (00:00-23:59)
  tide: number;  // cm単位の潮位
}

type TideDataArray = TideData[];
```

#### rechartsコンポーネント使用例

```typescript
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

<ResponsiveContainer width="100%" height={400}>
  <LineChart
    data={tideData}
    margin={{ top: 20, right: 20, bottom: 40, left: 60 }}
  >
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis
      dataKey="time"
      tick={{ fontSize: 12 }}
      height={40}
    />
    <YAxis
      label={{ value: '潮位 (cm)', angle: -90, position: 'insideLeft' }}
      tick={{ fontSize: 12 }}
      width={60}
    />
    <Tooltip />
    <Line
      type="monotone"
      dataKey="tide"
      stroke="#2563eb"
      strokeWidth={2}
      dot={false}
    />
  </LineChart>
</ResponsiveContainer>
```

#### エラーハンドリングの例

```typescript
if (!tideData || tideData.length <= 1) {
  return <div className="text-center text-gray-600">データ未取得</div>;
}

const isValidData = tideData.every(item =>
  typeof item.time === 'string' &&
  /^\d{2}:\d{2}$/.test(item.time) &&
  typeof item.tide === 'number' &&
  !isNaN(item.tide)
);

if (!isValidData) {
  return <div className="text-center text-red-600">データ形式エラー</div>;
}
```

---

**作成日**: 2025-09-25 / **更新日**: 2025-09-28
**担当者**: 潮汐システム開発チーム
**承認者**: プロダクトオーナー