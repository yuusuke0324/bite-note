name: Performance Monitoring

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ÊØéÊó•ÂçàÂâç9ÊôÇ„Å®ÂçàÂæå3ÊôÇ„Å´„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Çπ„Éà„ÇíÂÆüË°å
    - cron: '0 9,15 * * *'

jobs:
  performance-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install tsx for monitoring script
      run: npm install tsx

    - name: Run performance benchmarks
      run: npm run test src/__tests__/performance/TideCalculationBenchmark.test.ts

    - name: Run performance monitor
      run: npm run performance:test
      env:
        ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          performance-history.json
          performance.config.json
        retention-days: 30

    - name: Comment performance results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('performance-history.json')) {
            const history = JSON.parse(fs.readFileSync('performance-history.json', 'utf8'));
            const latest = history[0];

            if (latest) {
              const comment = `## üìä „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Çπ„ÉàÁµêÊûú

              **„Çπ„ÉÜ„Éº„Çø„Çπ**: ${latest.status === 'PASS' ? '‚úÖ PASS' : '‚ùå FAIL'}
              **„Éê„Éº„Ç∏„Éß„É≥**: ${latest.version.substring(0, 7)}
              **ÂÆüË°åÊôÇÈñì**: Âπ≥Âùá${latest.metrics.avgExecutionTime}ms, ÊúÄÂ§ß${latest.metrics.maxExecutionTime}ms
              **„É°„É¢„É™‰ΩøÁî®Èáè**: Âπ≥Âùá${(latest.metrics.avgMemoryUsage / 1024 / 1024).toFixed(1)}MB
              **„Ç≠„É£„ÉÉ„Ç∑„É•„Éí„ÉÉ„ÉàÁéá**: ${(latest.metrics.cacheHitRate * 100).toFixed(1)}%
              **„Ç™„Éº„Éê„Éº„Éò„ÉÉ„Éâ**: ${latest.metrics.overhead.toFixed(1)}%

              ${latest.thresholdViolations.length > 0 ?
                `### ‚ö†Ô∏è ÈñæÂÄ§ÈÅïÂèç\n${latest.thresholdViolations.map(v => `- ${v}`).join('\n')}` :
                '### ‚úÖ „Åô„Åπ„Å¶„ÅÆÈñæÂÄ§„Çí„ÇØ„É™„Ç¢'}
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          }

  continuous-monitoring:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install tsx for monitoring script
      run: npm install tsx

    - name: Start continuous monitoring
      run: |
        npm run performance:watch &
        MONITOR_PID=$!
        sleep 1800  # 30ÂàÜÈñìÁõ£Ë¶ñ
        kill $MONITOR_PID
      env:
        ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}