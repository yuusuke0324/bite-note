name: Split CI Tests
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # 高速で安定したコアテスト
  test-core:
    name: Core Logic Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Core Tests
      run: |
        npm run test:fast -- \
          --exclude="**/*.integration.test.ts" \
          --exclude="**/*.a11y.test.tsx" \
          --exclude="**/components/**/*.test.tsx" \
          --bail=3
      timeout-minutes: 10

  # UIコンポーネントテスト
  test-components:
    name: Component Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Component Tests
      run: |
        npm run test:fast -- \
          "src/components/**/*.test.tsx" \
          --exclude="**/*.a11y.test.tsx" \
          --exclude="**/*.integration.test.ts" \
          --bail=5
      timeout-minutes: 15

  # 統合テスト（オプショナル）
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # 失敗を許容
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Integration Tests
      run: |
        npm run test:fast -- \
          "**/*.integration.test.ts" \
          --bail=3
      timeout-minutes: 10

  # 必須テストの成功チェック
  check-required:
    name: Required Tests Check
    runs-on: ubuntu-latest
    needs: [test-core, test-components]
    steps:
    - name: All required tests passed
      run: echo "✅ All required tests passed!"